# Техническое задание: Beauty Tech Multi-Site Platform

## 1. Общее описание проекта

### 1.1 Назначение
Создание мультитенантной платформы для управления 4 сайтами косметических брендов в едином монорепозитории. Платформа включает полнофункциональный e-commerce с разделением на B2B и B2C сегменты, единый B2B кабинет и админ-панель для управления всеми сайтами.

### 1.2 Целевые сайты
1. **BTT** - полноценный e-commerce сайт
2. **AQ Skin Solutions** - полноценный e-commerce сайт
3. **Sciton** - одностраничный сайт (one-page)
4. **Indiba** - лендинг-страница

### 1.3 Основные требования
- Монорепозиторий с общей кодовой базой
- Единая база данных с мультитенантностью (разделение по `site_id`)
- Общие компоненты и утилиты
- Индивидуальная стилизация для каждого сайта
- Поддержка двух языков: немецкий (DE) и английский (EN)

---

## 2. Архитектура системы

### 2.1 Структура проекта

```
COSMETIC/
├── apps/
│   ├── btt/              # BTT e-commerce
│   ├── aq/               # AQ Skin Solutions
│   ├── sciton/           # Sciton one-page
│   └── indiba/           # Indiba landing
├── packages/
│   ├── shared/           # Общие компоненты, утилиты
│   ├── ui/               # shadcn/ui компоненты
│   ├── database/         # Supabase схемы, типы
│   ├── config/           # Конфиги сайтов
│   └── lib/              # Общие библиотеки
├── supabase/
│   ├── migrations/       # SQL миграции
│   └── functions/        # Edge Functions
└── docs/                 # Документация
```

### 2.2 Архитектурные принципы
- **Монорепозиторий:** Общая кодовая база для всех сайтов
- **Мультитенантность:** Разделение данных по `site_id` в единой БД
- **Общие компоненты:** Переиспользуемые UI компоненты и утилиты в `/shared`
- **Единый B2B кабинет:** Общий кабинет для всех сайтов с фильтрацией
- **Единая админ-панель:** Одна панель управления для всех сайтов

---

## 3. Технический стек

### 3.1 Frontend
- **Framework:** Next.js 15 (App Router)
- **UI библиотека:** React 19
- **Язык:** TypeScript
- **UI компоненты:** shadcn/ui, Radix UI
- **Стилизация:** Tailwind CSS
- **Интернационализация:** next-intl

### 3.2 Backend
- **База данных:** Supabase (PostgreSQL)
- **Аутентификация:** Supabase Auth
- **Безопасность:** Row Level Security (RLS)
- **Хранилище файлов:** Supabase Storage
- **Serverless функции:** Supabase Edge Functions

### 3.3 Интеграции
- **Платежи:** Stripe (карты, Apple Pay, Google Pay, Klarna)
- **Доставка:** DHL/Sendcloud API
- **Email:** Resend
- **Переводы:** DeepL API (опционально)
- **Аналитика:** Google Analytics 4, BigQuery

### 3.4 Инструменты разработки
- **Тестирование:** Playwright (E2E), Vitest (Unit)
- **Деплой:** Vercel
- **Монорепозиторий:** Turborepo или pnpm workspaces

---

## 4. Функциональные требования

### 4.1 Пользовательские роли

#### 4.1.1 B2C пользователи (обычные покупатели)
- Просмотр каталога товаров
- Просмотр страниц товаров
- Добавление товаров в корзину
- Использование промокодов
- Оформление заказа с оплатой через Stripe
- Получение email-уведомлений о заказе

#### 4.1.2 B2B пользователи (бизнес-клиенты)
- Доступ к специальным B2B ценам
- Просмотр истории заказов в личном кабинете
- Оформление заказа с оплатой по счету (требует модерации)
- Загрузка чеков/договоров после заказа
- Функция "Повторить заказ" (one-click)
- Получение автоматических напоминаний о повторном заказе

#### 4.1.3 Администраторы
- Управление товарами (CRUD)
- Управление коллекциями
- Управление ценами (B2B/B2C)
- Управление промокодами
- CSV импорт/экспорт товаров
- Модерация B2B заказов
- Просмотр всех заказов по всем сайтам

### 4.2 Система цен

#### 4.2.1 Разделение цен
- Каждый товар имеет две цены: `price_b2c` и `price_b2b`
- B2C пользователи видят только B2C цены
- B2B пользователи видят только B2B цены
- Цены скрыты через RLS политики в БД

#### 4.2.2 Отображение цен
- Динамическое отображение цены в зависимости от роли пользователя
- Middleware для определения роли пользователя
- Компонент `PriceDisplay` для унифицированного отображения

### 4.3 Корзина покупок

#### 4.3.1 Функционал корзины
- Добавление товаров в корзину
- Отображение товаров в корзине
- Изменение количества товаров
- Удаление товаров из корзины
- Сохранение корзины:
  - В localStorage для неавторизованных пользователей
  - В БД для авторизованных пользователей

#### 4.3.2 Расчет доставки
- Стоимость доставки: **6.99€** для заказов менее **300€**
- Бесплатная доставка для заказов от **300€**
- Интеграция с DHL/Sendcloud для расчета стоимости

#### 4.3.3 Промокоды
- Применение промокодов только для B2C пользователей
- Валидация промокодов
- Расчет скидки

### 4.4 Оформление заказа (Checkout)

#### 4.4.1 Страница оформления заказа
- Форма с данными покупателя
- Выбор способа доставки
- Выбор способа оплаты
- Итоговая стоимость заказа

#### 4.4.2 Способы оплаты

**Для B2C:**
- Stripe Checkout с поддержкой:
  - Банковские карты
  - Apple Pay
  - Google Pay
  - Klarna

**Для B2B:**
- Оплата по счету (требует модерации администратором)
- Создание заказа со статусом "Ожидает оплаты"

#### 4.4.3 Создание заказа
- Сохранение заказа в БД после успешной оплаты
- Отправка email-уведомления о заказе
- Обновление статуса заказа через Stripe webhook

### 4.5 Личный кабинет B2B

#### 4.5.1 Dashboard
- Обзор статистики заказов
- Последние заказы
- Быстрые действия

#### 4.5.2 История заказов
- Список всех заказов пользователя
- Фильтрация по сайтам
- Детали каждого заказа
- Статусы заказов
- Трекинг доставки

#### 4.5.3 Повтор заказа
- Кнопка "Повторить заказ" для каждого заказа
- One-click добавление всех товаров из заказа в корзину
- Автоматический переход на страницу checkout

#### 4.5.4 Загрузка файлов
- Возможность загрузить чек/договор после заказа
- Хранение файлов в Supabase Storage
- Отображение загруженных файлов в админ-панели

### 4.6 Админ-панель

#### 4.6.1 Управление товарами
- Создание нового товара
- Редактирование товара
- Удаление товара
- Управление изображениями товаров
- Управление описаниями и характеристиками

#### 4.6.2 Управление коллекциями
- Создание коллекций товаров
- Редактирование коллекций
- Удаление коллекций
- Привязка товаров к коллекциям

#### 4.6.3 Управление ценами
- Установка B2C цены
- Установка B2B цены
- Массовое редактирование цен

#### 4.6.4 Управление промокодами
- Создание промокодов
- Установка скидки
- Установка условий применения
- Деактивация промокодов

#### 4.6.5 CSV импорт/экспорт
- Импорт товаров из CSV файла
- Экспорт товаров в CSV файл
- Валидация данных при импорте

#### 4.6.6 Модерация B2B заказов
- Просмотр всех B2B заказов
- Изменение статуса заказа
- Одобрение заказов на оплату по счету
- Просмотр загруженных файлов (чеки/договоры)

### 4.7 Интеграция доставки

#### 4.7.1 Расчет стоимости доставки
- Интеграция с DHL/Sendcloud API
- Автоматический расчет стоимости на основе адреса доставки
- Отображение стоимости в корзине и на checkout

#### 4.7.2 Трекинг заказов
- Получение трек-номера от службы доставки
- Отображение статуса доставки в личном кабинете
- Автоматическое обновление статусов через webhook

### 4.8 Email уведомления

#### 4.8.1 Типы уведомлений
- **Подтверждение заказа:** Отправка сразу после создания заказа
- **Напоминание о повторном заказе:** Автоматическая отправка через 1 месяц после заказа (только для B2B)

#### 4.8.2 Технические требования
- Использование Resend для отправки email
- HTML шаблоны для писем
- Поддержка DE/EN языков в письмах

### 4.9 Интернационализация (i18n)

#### 4.9.1 Поддерживаемые языки
- Немецкий (DE) - основной
- Английский (EN)

#### 4.9.2 Функционал
- Переключение языка на сайте
- Автоматическое определение языка по геолокации (опционально)
- Переводы всех текстов интерфейса
- Автоперевод контента через DeepL API (опционально)

### 4.10 SEO и Legal страницы

#### 4.10.1 SEO оптимизация
- Schema.org разметка (Product, FAQ)
- Sitemap.xml для каждого сайта
- Meta-теги (title, description, og:tags)
- Canonical URLs
- Оптимизация изображений (WebP формат)

#### 4.10.2 Legal страницы
- FAQ (Часто задаваемые вопросы)
- Contacts (Контакты)
- Legal страницы:
  - GDPR (Политика конфиденциальности)
  - Cookies Policy
  - Imprint (Импринт)
  - Terms & Conditions (Условия использования)

#### 4.10.3 Дополнительно
- Cookie consent (согласие на использование cookies)
- 404 страница с навигацией

### 4.11 Аналитика

#### 4.11.1 Google Analytics 4
- Интеграция GA4 на все сайты
- E-commerce события (просмотр товара, добавление в корзину, покупка)
- Трекинг конверсий
- Экспорт данных в BigQuery

---

## 5. Требования к базе данных

### 5.1 Основные таблицы

#### 5.1.1 sites
- Хранение информации о сайтах (BTT, AQ, Sciton, Indiba)
- Поля: `id`, `name`, `domain`, `config`

#### 5.1.2 users
- Расширенная таблица пользователей Supabase Auth
- Поля: `id`, `email`, `role` (b2c/b2b/admin), `site_id`

#### 5.1.3 products
- Каталог товаров
- Поля: `id`, `site_id`, `name`, `slug`, `description`, `images`, `price_b2c`, `price_b2b`, `stock`, `status`

#### 5.1.4 collections
- Коллекции товаров
- Поля: `id`, `site_id`, `name`, `slug`, `description`

#### 5.1.5 orders
- Заказы
- Поля: `id`, `site_id`, `user_id`, `status`, `payment_method`, `shipping_address`, `total`, `created_at`

#### 5.1.6 order_items
- Товары в заказе
- Поля: `id`, `order_id`, `product_id`, `quantity`, `price`

#### 5.1.7 promocodes
- Промокоды
- Поля: `id`, `code`, `discount`, `valid_from`, `valid_until`, `active`

### 5.2 Row Level Security (RLS)
- Все таблицы защищены RLS политиками
- Разделение данных по `site_id`
- B2B цены скрыты от B2C пользователей
- Доступ к админ-панели только для администраторов

---

## 6. Этапы разработки

### Этап 1: Прототип (Дни 1-3)
**Цель:** Создать базовую структуру проекта и прототип одного сайта

**Задачи:**
1. Инициализация монорепозитория Next.js 15
2. Настройка TypeScript, ESLint, Prettier
3. Настройка Supabase проекта
4. Создание базовой схемы БД
5. Базовые страницы для AQ (главная, каталог, товар, авторизация)
6. B2B кабинет MVP (dashboard, список заказов)

**Результат:** Live-демо на Vercel с каталогом и B2B кабинетом

### Этап 2: MVP E-commerce (Дни 4-10)
**Цель:** Реализовать полный цикл покупки

**Задачи:**
1. Система цен (B2B/B2C)
2. Корзина покупок
3. Checkout с интеграцией Stripe
4. Email уведомления через Resend

**Результат:** Полный цикл покупки B2C и B2B

### Этап 3: Полный функционал (Дни 11-15)
**Цель:** Реализовать все основные функции платформы

**Задачи:**
1. Админ-панель (CRUD товаров, промокоды, CSV импорт/экспорт)
2. Интеграция доставки (DHL/Sendcloud)
3. Повтор заказа для B2B
4. Авто-уведомления (напоминания через 1 месяц)
5. Загрузка файлов B2B
6. i18n (DE/EN)
7. Создание остальных сайтов (BTT, Sciton, Indiba)
8. SEO и Legal страницы

**Результат:** Полнофункциональная платформа со всеми фичами

### Этап 4: Тестирование и деплой (Дни 16-20)
**Цель:** Подготовка к production

**Задачи:**
1. E2E тесты (Playwright)
2. Unit тесты
3. Оптимизация (Lighthouse >95)
4. Деплой на Vercel
5. Настройка аналитики (GA4)
6. Документация

**Результат:** Готовый к продакшену проект с документацией

---

## 7. Требования к производительности

### 7.1 Производительность
- Lighthouse Score > 95 по всем метрикам
- Оптимизация изображений (WebP формат)
- Code splitting для уменьшения bundle size
- PWA поддержка

### 7.2 Безопасность
- Все API endpoints защищены аутентификацией
- RLS политики на уровне БД
- Валидация всех пользовательских данных
- Защита от CSRF и XSS атак

---

## 8. Требования к тестированию

### 8.1 E2E тесты (Playwright)
- Тест полного цикла покупки B2C
- Тест оформления заказа B2B
- Тест авторизации и доступа к кабинету
- Тест работы корзины

### 8.2 Unit тесты (Vitest)
- Тесты утилит (pricing, cart, promocodes)
- Тесты компонентов
- Тесты API endpoints

---

## 9. Документация

### 9.1 Техническая документация
- README с инструкциями по запуску проекта
- API документация
- Описание архитектуры
- Инструкции по деплою

### 9.2 Пользовательская документация
- Инструкции для администраторов
- Руководство по использованию админ-панели
- FAQ для пользователей

---

## 10. Риски и митигация

### 10.1 Риски

**Риск 1:** Задержка с фото/видео товаров
- **Митигация:** Использовать placeholder изображения на этапе разработки

**Риск 2:** Сложность интеграций с внешними API
- **Митигация:** Начать с моков API, затем постепенно переходить на реальные интеграции

**Риск 3:** Недостаток времени на реализацию всех функций
- **Митигация:** Приоритизировать MVP функционал, отложить nice-to-have фичи

**Риск 4:** Проблемы с производительностью при большом количестве товаров
- **Митигация:** Использовать пагинацию, индексы в БД, кэширование

---

## 11. Критерии приемки

### 11.1 Функциональные критерии
- ✅ Все 4 сайта работают и доступны
- ✅ Полный цикл покупки работает для B2C и B2B
- ✅ Админ-панель позволяет управлять всеми сайтами
- ✅ Интеграции с Stripe, DHL/Sendcloud, Resend работают
- ✅ Email уведомления отправляются корректно
- ✅ i18n работает для DE/EN

### 11.2 Технические критерии
- ✅ Lighthouse Score > 95
- ✅ Все тесты проходят
- ✅ Нет критических ошибок в консоли
- ✅ RLS политики работают корректно
- ✅ Проект деплоится на Vercel без ошибок

### 11.3 Бизнес-критерии
- ✅ Пользователи могут совершать покупки
- ✅ B2B клиенты видят специальные цены
- ✅ Администраторы могут управлять контентом
- ✅ Все Legal страницы присутствуют

---

## 12. Контакты и ответственные

*[Здесь указываются контакты заказчика, разработчиков и других ответственных лиц]*

---

**Дата создания ТЗ:** [Дата]  
**Версия:** 1.0  
**Статус:** Утверждено

